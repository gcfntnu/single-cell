#-*- mode:snakemake -*-

extra_conf_fn = srcdir('cellranger.config')
if os.path.exists(extra_conf_fn):
    with open(extra_conf_fn) as fh:
        c  = yaml.load(fh) or {}
        update_config2(config, c)

#config
ORG = config.get('organism', 'homo_sapiens')
FASTQ_DIR = config.get('fastq_dir', 'data/raw/fastq')
CR_PROCESSED = join(PROCESSED_DIR, 'cellranger')
CR_INTERIM = join(INTERIM_DIR, 'cellranger')
CR_CONF = config.get('cellranger')
REF = config['quant']['reference']


def get_aggr_mol(wildcards):
    samples = CR_AGGR[wildcards.group]
    DIR = join(CR_INTERIM, REF)
    mol_files = expand(join(DIR, '{sample}', 'outs', 'molecule_info.h5'), sample=samples)
    return mol_files

rule cellranger_count:
    input:
        R1 = get_filtered_fastq_R1,
        R2 = get_filtered_fastq_R2,
        transcriptome = join(EXT_DIR, REF, 'reference.json')
    params:
        input = rules.fastp_10x.params.out if not config['filter']['skip'] else FASTQ_DIR,
        id = '{sample}',
        outdir = join(CR_INTERIM, REF, '{sample}'),
        sample = '{sample}',
        transcriptome = join(EXT_DIR, REF),
        ncells = 3000
    threads:
        8
    output:
        summary = join(CR_INTERIM, REF, '{sample}', 'outs', 'web_summary.html'),
        raw_h5 = join(CR_INTERIM, REF, '{sample}', 'outs', 'raw_feature_bc_matrix.h5'),
        filt_h5 = join(CR_INTERIM, REF, '{sample}', 'outs', 'filtered_feature_bc_matrix.h5'),
        mol_h5 = join(CR_INTERIM, REF, '{sample}', 'outs', 'molecule_info.h5'),
        raw_mtx = directory(join(CR_INTERIM, REF, '{sample}', 'outs', 'raw_feature_bc_matrix')),
        filt_mtx = directory(join(CR_INTERIM, REF, '{sample}', 'outs', 'filtered_feature_bc_matrix'))
    singularity:
        CR_CONF['docker']
    shell:
        'cellranger count '
        '--fastqs {params.input} '
        '--id {params.id} '
        '--sample {params.sample} '
        '--transcriptome {params.transcriptome} '
        '--expect-cells {params.ncells} '
        '--localcores {threads} '
        '&& mv {params.id}/* {params.outdir}/ '
        '&& rmdir {params.id}'

rule cellranger_aggr_csv:
    input:
        get_aggr_mol
    output:
        join(CR_INTERIM, '{group}_aggr.csv')
    shell:
        ''
        
rule cellranger_aggr:
    input:
        csv = rules.cellranger_aggr_csv.output
    shell:
        'cellranger aggr '
        '--csv {input.csv} '
        '--id {group} '
        '--normalize=mapped '

rule cellranger_seurat:
    input:
        join(CR_INTERIM, REF, '{sample}', 'outs','filtered_feature_bc_matrix')
    params:
        script = srcdir('scripts/cellranger_seurat.R')
    output:
        join(CR_PROCESSED, 'seurat', '{sample}', '{sample}.rds')
    singularity:
        'docker://flatberg/seurat:dev-3.0.1'
    shell:
        'Rscript {params.script} --input {input} --output {output}'

rule cellranger_scanpy:
    input:
        join(CR_INTERIM, REF, '{sample}', 'outs','filtered_feature_bc_matrix')
    params:
        script = srcdir('scripts/cellranger_scanpy.py'),
        genome = '--genome {}'.format(config['scanpy']['genome']) if 'scanpy' in config else ''
    output:
        join(CR_PROCESSED, 'scanpy', '{sample}', '{sample}.h5ad')
    singularity:
        'docker://gcfntnu/scanpy:1.3.4'
    shell:
        'python {params.script} -i {input} -o {output} {params.genome} '
